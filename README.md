```
 _____ ______   ________  _______   ________  ___       ________      ___    ___ _______   ________     
|\   _ \  _   \|\   __  \|\  ___ \ |\   __  \|\  \     |\   __  \    |\  \  /  /|\  ___ \ |\   __  \    
\ \  \\\__\ \  \ \  \|\  \ \   __/|\ \  \|\  \ \  \    \ \  \|\  \   \ \  \/  / | \   __/|\ \  \|\  \   
 \ \  \\|__| \  \ \   _  _\ \  \_|/_\ \   ____\ \  \    \ \   __  \   \ \    / / \ \  \_|/_\ \   _  _\  
  \ \  \    \ \  \ \  \\  \\ \  \_|\ \ \  \___|\ \  \____\ \  \ \  \   \/  /  /   \ \  \_|\ \ \  \\  \| 
   \ \__\    \ \__\ \__\\ _\\ \_______\ \__\    \ \_______\ \__\ \__\__/  / /      \ \_______\ \__\\ _\ 
    \|__|     \|__|\|__|\|__|\|_______|\|__|     \|_______|\|__|\|__|\___/ /        \|_______|\|__|\|__|
                                                                    \|___|/                             
```
## 作用
对测试环境数据库重放录制的MySQL请求

## 录制方式
该工具读取tcpdump的产物，因此需要使用tcpdump进行流量录制，命令如下：
```sh
tcpdump -s 0 -i eth0 dst port 4000 and tcp -w /run/test.pcap
```
其中`-s 0`表示捕获整个数据包，`-i eth0`表示在eth0网卡上录制数据，`dst port 4000 and tcp`表示捕获目标端口为`4000`的TCP数据包，取决于线上数据库在哪个端口监听，然后`-w /run/test/pcap`表示将录制的数据写到`/run/test.pcap`

如果记不住这么多参数又经常需要录制的话，可以把上述命令写到一个脚本里`record.sh`:
```sh
#! /bin/sh

tcpdump -s 0 -i eth0 dst port 4000 and tcp -w /run/test.pcap
```
这就是我们录制流量的小工具啦！当然你可以对脚本内容做一些小调整让它更高效，比如加上-B参数来避免突发流量时tcpdump处理不过来造成的丢包

## 回放方式
要回放流量，需要先解析tcpdump的录制结果，假定录制产物为`/run/test.pcap`，需要先这样处理一下:
```sh
mysql-replayer prepare -i /run/test.pcap -o /tmp/test
```
这会对pcap文件进行分析，并将分析结果放在/tmp/test目录里（如果`/tmp/test`目录不存在则自动创建，若为非目录则报错），分析之后输出产物为一系列文件，类似这样：
```
1550990789-194.32.77.196-56598-498081.rec
1550990789-194.32.77.196-57616-137694.rec
1550990790-194.32.77.196-57490-118496.rec
1550990789-194.32.77.196-56600-727887.rec
1550990789-194.32.77.196-57618-167221.rec
1550990792-194.32.77.196-57266-62854.rec
1550990789-194.32.77.196-56602-131847.rec
1550990789-194.32.77.196-57620-586574.rec  
1550990792-194.32.77.196-57268-60294.rec
```